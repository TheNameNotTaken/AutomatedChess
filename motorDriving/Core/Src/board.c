#include "board.h"
#include "main.h"
#include "magnetController.h"
#include <ctype.h>

#define TOLERANCE 100

extern ADC_HandleTypeDef hadc1;
extern char activeColor;

// add pin assignments
Pin masterSel0 = {GPIOC, GPIO_PIN_6};
Pin masterSel1 = {GPIOB, GPIO_PIN_15};
Pin masterSel2 = {GPIOB, GPIO_PIN_13};
Mux masterMux = {&masterSel0, &masterSel1, &masterSel2};

Pin colSel0 = {GPIOB, GPIO_PIN_12};
Pin colSel1 = {GPIOA, GPIO_PIN_4};
Pin colSel2 = {GPIOB, GPIO_PIN_4};
Mux colMux = {&colSel0, &colSel1, &colSel2};

/*
 * chess board has default value shown below
 * uppercase letters mean that a piece is white and undercase means black
 * legend is following:
 * r/R = rook
 * n/N = knight
 * b/B = bishop
 * k/K = king
 * q/Q = queen
 * p/P = pawn
 * - = empty space
 */
//char board[8][8] = 	{{'r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'},
//					 {'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'},
//					 {'-', '-', '-', '-', '-', '-', '-', '-'},
//					 {'-', '-', '-', '-', '-', '-', '-', '-'},
//					 {'-', '-', '-', '-', '-', '-', '-', '-'},
//					 {'-', '-', '-', '-', '-', '-', '-', '-'},
//					 {'P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'},
//					 {'R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'}};
char board[8][8] = 	{{'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'}};
char newBoard[8][8] = 	{{'r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'},
					 {'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'},
					 {'R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'}};

char black_white_board[8][8] = {{'r', 'n', 'b', 'k', 'q', 'b', 'n', 'r'},
		 {'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'},
		 {'-', '-', '-', '-', '-', '-', '-', '-'},
		 {'-', '-', '-', '-', '-', '-', '-', '-'},
		 {'-', '-', '-', '-', '-', '-', '-', '-'},
		 {'-', '-', '-', '-', '-', '-', '-', '-'},
		 {'P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'},
		 {'R', 'N', 'B', 'K', 'Q', 'B', 'N', 'R'}};
//Next to move, 'w' for white 'b' for black
char activeColor = 'w';

char playerColor = 'w';

//flags used to indicate what needs to be picked up
int numToPickUp = 0;
char toPickUp[4][3] = {'\0', '\0', '\0', '\0'};

char pieces[13] = {'P', 'R', 'N', 'B', 'Q', 'K','-', 'p', 'r', 'n', 'b', 'q', 'k'};
enum PieceName {WP, WR, WN, WB, WQ, WK, EMP, BP, BR, BN, BB, BQ, BK};
uint32_t hallValues[13][8][8] = {
		//square for WP
		//the squares at B6, D6, F2 does not work
		{{2679, 2676, 2697, 2670, 2650, 2671, 2628, 2678},//A
		 {2762, 2743, 2714, 2659, 2618, 2623, 2222, 2612},//B
		 {2868, 2578, 2529, 2482, 2425, 2490, 2535, 2470},//C
		 {2500, 2459, 2413, 2323, 2382, 2338, 2222, 2323},//D
		 {2600, 2506, 2627, 2470, 2598, 2536, 2575, 2566},//E
		 {2750, 2633, 2222, 2564, 2498, 2471, 2485, 2519},//F
		 {2650, 2578, 2587, 2545, 2504, 2494, 2633, 2500},//G
		 {2575, 2640, 2748, 2613, 2667, 2627, 2625, 2650} //H
		},//pawn
			//2252, 2259, 2222, 2254
		{{2915, 2906, 2900, 2968, 2857, 2965, 2800, 2935},//A
		 {3056, 2998, 2848, 2847, 2785, 2760, 2222, 2800},//B
		 {3027, 2749, 2725, 2729, 2600, 2649, 2599, 2567},//C
		 {2758, 2826, 2581, 2525, 2642, 2447, 2222, 2496},//D
		 {2626, 2852, 2803, 2771, 2689, 2565, 2667, 2642},//E
		 {2823, 2794, 2222, 2866, 2758, 2599, 2637, 2669},//F
		 {2777, 2872, 2703, 2745, 2783, 2624, 2658, 2731},//G
		 {2895, 3031, 3072, 2904, 2929, 2933, 3053, 3053} //H
		},//rook
		{{3211, 3288, 3125, 3087, 3085, 3138, 3120, 3060},//A
		 {3155, 3211, 2972, 3057, 2863, 2861, 2222, 2941},//B
		 {3272, 3032, 2979, 2790, 2702, 2700, 2754, 2687},//C
		 {2903, 2935, 2992, 2631, 2764, 2741, 2222, 2539},//D
		 {3050, 2926, 3201, 2939, 2760, 2826, 2796, 2914},//E
		 {2924, 2963, 2222, 2974, 2955, 2796, 2862, 2932},//F
		 {3011, 3064, 2805, 2831, 2883, 2804, 2877, 2900},//G
		 {3169, 3073, 3113, 3135, 3146, 3441, 3227, 3227} //H
		},//horse
		{{3516, 3441, 3405, 3436, 3394, 3430, 3385, 3231},//A
		 {3421, 3462, 3273, 3202, 3065, 3118, 2222, 3068},//B
		 {3437, 3323, 3237, 3100, 2950, 2900, 2887, 2826},//C
		 {3419, 3071, 2946, 2804, 2827, 2877, 2222, 2632},//D
		 {3498, 3146, 3454, 3134, 2951, 3088, 2948, 3116},//E
		 {3585, 3190, 2222, 3143, 3060, 2890, 2908, 3030},//F
		 {3389, 3319, 3214, 2954, 3043, 2908, 2992, 2963},//G
		 {3298, 3482, 3536, 3406, 3507, 3667, 3423, 3371} //H
		},//bishop
		{{4077, 4048, 3790, 4037, 3952, 3990, 3947, 3950},//A
		 {4051, 4006, 4004, 3955, 3678, 3738, 2222, 3629},//B
		 {4090, 3988, 3870, 3619, 3411, 3468, 3464, 3362},//C
		 {3899, 3793, 3742, 3559, 3309, 3335, 2222, 3177},//D
		 {3961, 3767, 3971, 3768, 3453, 3338, 3386, 3618},//E
		 {3999, 3925, 2222, 3650, 3472, 3421, 3400, 3186},//F
		 {3852, 3918, 3720, 3649, 3428, 3318, 3500, 3537},//G
		 {3923, 4099, 4068, 4002, 4103, 4084, 3990, 4077} //H
		},//queen
		{{3881, 3940, 3690, 3738, 3878, 3914, 3815, 3753},//A
		 {3787, 3929, 3486, 3575, 3318, 3439, 2222, 3213},//B
		 {3841, 3574, 3603, 3462, 3211, 3156, 3316, 3280},//C
		 {3563, 3571, 3447, 3399, 3140, 3180, 2222, 3077},//D
		 {3605, 3555, 3697, 3488, 3260, 3218, 3222, 3471},//E
		 {3653, 3672, 2222, 3343, 3359, 3272, 3249, 3063},//F
		 {3679, 3632, 3566, 3408, 3248, 3169, 3363, 3364},//G
		 {3845, 3922, 3900, 3843, 3970, 3808, 3852, 3908} //H
		},//king
		{{2487, 2509, 2478, 2507, 2475, 2491, 2498, 2511},//A
		{2525, 2490, 2468, 2465, 2453, 2490, 2222, 2444},//B
		{2537, 2403, 2370, 2389, 2331, 2396, 2418, 2362},//C
		{2312, 2292, 2289, 2246, 2252, 2259, 2222, 2254},//D
		{2286, 2377, 2452, 2382, 2424, 2425, 2423, 2401},//E
		{2390, 2411, 2222, 2413, 2386, 2372, 2404, 2350},//F
		{2366, 2428, 2374, 2385, 2366, 2334, 2421, 2390},//G
		{2459, 2518, 2561, 2494, 2500, 2458, 2458, 2512}},//H

//		{{2147, 2212, 2288, 2237, 2221, 2205, 2236, 2269},//A
//		 {2328, 2250, 2280, 2283, 2292, 2279, 2222, 2305},//B
//		 {2262, 2168, 2158, 2223, 2175, 2265, 2277, 2234},//C
//		 {1957, 2020, 2040, 2018, 2055, 2080, 2220, 2106},//D
//		 {1905, 2106, 2197, 2167, 2261, 2274, 2270, 2251},//E
//		 {2042, 2148, 2222, 2223, 2201, 2216, 2245, 2212},//F
//		 {2064, 2121, 2138, 2154, 2167, 2157, 2239, 2224},//G
//		 {2100, 2197, 2251, 2198, 2162, 2119, 2097, 2177} //H
//		},//black pawn
		{{2251, 2269, 2227, 2266, 2225, 2276, 2251, 2268},//A
		 {2328, 2485, 2332, 2283, 2326, 2378, 2222, 2305},//B
		 {2292, 2168, 2158, 2223, 2175, 2265, 2277, 2234},//C
		 {1997, 2020, 2040, 2118, 2105, 2140, 2220, 2174},//D
		 {2035, 2106, 2197, 2167, 2321, 2324, 2347, 2361},//E
		 {2042, 2148, 2222, 2223, 2261, 2277, 2314, 2292},//F
		 {2064, 2121, 2138, 2184, 2267, 2187, 2359, 2264},//G
		 {2100, 2230, 2251, 2198, 2162, 2119, 2097, 2257} //H
		},//black pawn

		{{1916, 2143, 2084, 2055, 2127, 1925, 2075, 2147},//A
		 {2015, 1894, 2120, 2074, 2205, 2125, 2222, 2153},//B
		 {2097, 1944, 1869, 2028, 2039, 2154, 2200, 2155},//C
		 {1798, 1845, 1921, 1958, 1992, 2019, 2222, 2122},//D
		 {1560, 1953, 2098, 2130, 2243, 2250, 2280, 2251},//E
		 {1942, 1985, 2222, 2183, 2183, 2236, 2279, 2252},//F
		 {1930, 1944, 2066, 2093, 2125, 2130, 2230, 2206},//G
		 {1985, 1930, 2102, 1900, 2066, 1898, 1921, 1997} //H
		},//black rook
		{{1715, 1881, 1984, 1836, 1850, 1766, 2005, 1980},//A
		{1839, 1702, 1904, 1885, 1954, 1998, 2222, 2043},//B
		{1859, 1757, 1731, 1858, 1902, 2118, 2102, 2046},//C
		{1666, 1751, 1798, 1818, 1935, 1972, 2222, 2106},//D
		{1638, 1831, 1937, 1984, 2151, 2169, 2222, 2188},//E
		{1746, 1855, 2222, 2042, 2113, 2135, 2243, 2128},//F
		{1738, 1771, 1900, 2001, 2052, 2049, 2146, 2135},//G
		{1734, 1874, 1958, 1790, 1912, 1649, 1724, 1849} //H
	},//black horse
		{{1126, 1737, 1625, 1724, 1559, 1485, 1458, 1569},//A
		 {1599, 1428, 1587, 1620, 1675, 1649, 2222, 1761},//B
		 {1438, 1450, 1448, 1678, 1797, 1857, 1874, 1878},//C
		 {1500, 1225, 1573, 1489, 1745, 1811, 2222, 1907},//D
		 {1183, 1558, 1454, 1586, 2030, 2109, 2079, 1972},//E
		 {1514, 1701, 2222, 1897, 1793, 2006, 2125, 2054},//F
		 {1463, 1468, 1449, 1783, 1889, 1758, 1758, 2055},//G
		 {1545, 1546, 1467, 1388, 1405, 1107, 1368, 1510} //H
		},//black bishop
		{{952, 981, 1080, 1098, 895, 952, 943, 1144},//A
		 {978, 900, 1075, 1051, 1236, 1249, 2222, 1432},//B
		 {1000, 913, 1009, 1158, 1310, 1539, 1555, 1414},//C
		 {921, 1000, 1138, 1251, 1250, 1350, 2222, 1313},//D
		 {889, 1109, 1245, 1440, 1470, 1400, 1593, 1355},//E
		 {959, 1160, 2222, 1585, 1368, 1397, 1541, 1066},//F
		 {972, 976, 1197, 1473, 1160, 1080, 1417, 1199},//G
		 {957,  966, 1054, 918,  802,  946,  837, 1086} //H
		},//black queen
		{{1026, 1196, 1231, 1181, 992, 1256, 1031, 1310},//A
		 {1241, 1263, 1450, 1555, 1356, 1495, 2222, 1500},//B
		 {1339, 1010, 1225, 1447, 1410, 1660, 1740, 1560},//C
		 {1163, 1141, 1257, 1367, 1322, 1490, 2222, 1423},//D
		 {967, 1277, 1220, 1450, 1572, 1495, 1692, 1450},//E
		 {1067, 1258, 2222, 1737, 1464, 1521, 1726, 1133},//F
		 {1028, 1204, 1288, 1538, 1257, 1193, 1542, 1320},//G
		 {1054, 1125, 1209, 1200, 1144, 1087, 1030, 1173} //H
		}//black king

};

//uint32_t hallValues[13][8][8] = {
//		//square for WP
//		//the squares at B6, D6, F2 does not work
//		{{2861, 2851, 2977, 2986, 2783, 3015, 2870, 2995},//A
//		 {3095, 3071, 2822, 2922, 2807, 2727, 2222, 2696},//B
//		 {2819, 2897, 2692, 2660, 2548, 2597, 2560, 2531},//C
//		 {2742, 2631, 2624, 2519, 2453, 2427, 2222, 2369},//D
//		 {2730, 2746, 2831, 2592, 2558, 2514, 2514, 2445},//E
//		 {2641, 2800, 2222, 2628, 2549, 2473, 2478, 2423},//F
//		 {2866, 2927, 2685, 2615, 2568, 2490, 2575, 2493},//G
//		 {2843, 3121, 3047, 2946, 2949, 2915, 2920, 2991} //H
//		},//pawn
//
//		{{3011, 2886, 2904, 2968, 2857, 2965, 2800, 2935},//A
//		 {2976, 2998, 2848, 2847, 2785, 2760, 2222, 2710},//B
//		 {2787, 2705, 2767, 2729, 2600, 2649, 2559, 2497},//C
//		 {2758, 2616, 2591, 2525, 2442, 2447, 2222, 2396},//D
//		 {2626, 2702, 2803, 2571, 2589, 2555, 2567, 2542},//E
//		 {2823, 2794, 2222, 2666, 2558, 2499, 2537, 2469},//F
//		 {2777, 2872, 2703, 2645, 2575, 2524, 2598, 2531},//G
//		 {2895, 3031, 3072, 2904, 2929, 2933, 2947, 2953} //H
//		},//rook
//		{{2965, 3088, 3125, 3087, 3085, 3138, 3120, 3060},//A
//		 {3205, 3211, 2972, 3057, 2863, 2861, 2222, 2710},//B
//		 {2972, 2932, 2713, 2750, 2702, 2700, 2734, 2667},//C
//		 {2903, 2835, 2742, 2631, 2504, 2541, 2222, 2439},//D
//		 {2840, 2826, 2901, 2739, 2660, 2626, 2596, 2614},//E
//		 {2924, 2863, 2222, 2774, 2655, 2596, 2562, 2532},//F
//		 {3011, 3064, 2805, 2731, 2683, 2604, 2677, 2600},//G
//		 {3169, 3073, 3113, 3135, 3146, 3241, 2823, 3027} //H
//		},//horse
//		{{3516, 3471, 3405, 3436, 3394, 3430, 3385, 3231},//A
//		 {3421, 3462, 3273, 3202, 3065, 3118, 2222, 3068},//B
//		 {3237, 3323, 3237, 3100, 2950, 2800, 2887, 2826},//C
//		 {3119, 3071, 2946, 2804, 2627, 2677, 2222, 2592},//D
//		 {3098, 3146, 3174, 2934, 2811, 2788, 2748, 2716},//E
//		 {3085, 3090, 2222, 2943, 2810, 2690, 2708, 2630},//F
//		 {3289, 3319, 2914, 2954, 2843, 2708, 2792, 2763},//G
//		 {3298, 3482, 3536, 3406, 3507, 3467, 3423, 3371} //H
//		},//bishop
//		{{4047, 4048, 4000, 4037, 3802, 3920, 4047, 3850},//A
//		 {4051, 4066, 4004, 3955, 3678, 3738, 2222, 3629},//B
//		 {3890, 3888, 3870, 3619, 3411, 3468, 3264, 3142},//C
//		 {3699, 3693, 3442, 3259, 3109, 2975, 2222, 2877},//D
//		 {3661, 3767, 3771, 3268, 3153, 2978, 2986, 3018},//E
//		 {3859, 3575, 2222, 3400, 3172, 3021, 3989, 2886},//F
//		 {3852, 3918, 3620, 3449, 3188, 3118, 3200, 3137},//G
//		 {3923, 4089, 4068, 4062, 3593, 4084, 4080, 4047} //H
//		},//queen
//		{{3981, 3840, 3740, 3738, 3788, 3814, 3815, 3553},//A
//		 {3787, 3959, 3486, 3575, 3318, 3439, 2222, 3213},//B
//		 {3641, 3574, 3603, 3462, 3211, 3156, 3116, 3080},//C
//		 {3363, 3171, 3147, 3099, 2940, 2880, 2222, 2777},//D
//		 {3205, 3455, 3397, 3188, 2960, 2918, 2822, 2871},//E
//		 {3653, 3332, 2222, 3143, 2959, 2872, 2849, 2763},//F
//		 {3679, 3532, 3366, 3208, 3048, 2969, 3013, 2964},//G
//		 {3845, 3722, 3900, 3643, 3870, 3808, 3842, 3718} //H
//		},//king
//		{{2487, 2509, 2478, 2507, 2475, 2491, 2498, 2511},
//		{2525, 2488, 2468, 2465, 2453, 2460, 2222, 2444},
//		{2537, 2403, 2370, 2389, 2331, 2396, 2418, 2362},
//		{2312, 2292, 2289, 2246, 2252, 2259, 2222, 2254},
//		{2286, 2377, 2452, 2382, 2424, 2425, 2423, 2401},
//		{2390, 2411, 2222, 2413, 2386, 2372, 2404, 2350},
//		{2366, 2428, 2374, 2385, 2366, 2334, 2421, 2390},
//		{2459, 2518, 2561, 2494, 2500, 2458, 2458, 2512}},
//
//		{{1953, 2195, 1922, 2303, 1955, 2100, 2047, 2156},//A
//		 {2140, 1931, 2083, 2090, 2110, 2309, 2222, 2160},//B
//		 {2014, 1993, 1902, 2070, 2093, 2251, 2248, 2212},//C
//		 {1976, 1867, 1952, 2025, 2126, 2133, 2222, 2174},//D
//		 {1774, 2096, 2121, 2151, 2282, 2290, 2330, 2350},//E
//		 {1896, 2002, 2222, 2190, 2237, 2260, 2320, 2269},//F
//		 {2008, 2100, 2175, 2157, 2182, 2196, 2270, 2260},//G
//		 {1908, 1902, 2027, 2155, 1998, 1814, 2133, 2140} //H
//		},//black pawn
//
//		{{2046, 2143, 1944, 2055, 2127, 1925, 2085, 1900},//A
//		 {2015, 1894, 2120, 2074, 2205, 1649, 2222, 2143},//B
//		 {1897, 1944, 1869, 2028, 2039, 2154, 2200, 2121},//C
//		 {1968, 1845, 1921, 1958, 1992, 2019, 2222, 2122},//D
//		 {1560, 2053, 2098, 2130, 2243, 2250, 2280, 2072},//E
//		 {1892, 1985, 2222, 2183, 2183, 2227, 2257, 2218},//F
//		 {1930, 1944, 2066, 2093, 2125, 2127, 2230, 2206},//G
//		 {1985, 1930, 2002, 1994, 2066, 1898, 1921, 1997} //H
//		},//black rook
//		{{1985, 1881, 1774, 1836, 2193, 1766, 2108, 2157},//A
//		{1839, 1702, 1904, 1885, 1994, 1988, 2222, 1983},//B
//		{1699, 1757, 1731, 1858, 1902, 2118, 2102, 2046},//C
//		{1666, 1751, 1798, 1818, 1935, 1972, 2222, 2106},//D
//		{1638, 1831, 1937, 1984, 2151, 2169, 2222, 2188},//E
//		{1746, 1855, 2222, 2042, 2113, 2139, 2243, 2168},//F
//		{1738, 1771, 1900, 2001, 2052, 2049, 2146, 2135},//G
//		{1734, 1834, 1978, 1960, 1912, 1649, 1704, 1849} //H
//	},//black horse
//		{{1726, 1737, 1625, 1724, 1559, 1595, 1458, 1769},//A
//		 {1599, 1428, 1747, 1620, 1675, 2125, 2222, 1761},//B
//		 {1438, 1450, 1448, 1678, 1797, 1857, 1874, 1878},//C
//		 {1500, 1385, 1573, 1689, 1745, 1811, 2222, 1927},//D
//		 {1313, 1558, 1654, 1786, 2030, 2109, 2079, 2072},//E
//		 {1514, 1701, 2222, 1897, 1993, 2006, 2125, 2054},//F
//		 {1463, 1448, 1649, 1783, 1889, 1928, 2058, 2055},//G
//		 {1545, 1546, 1427, 1518, 1405, 1307, 1578, 1510} //H
//		},//black bishop
//		{{972, 981, 970, 1128, 995, 1052, 1083, 1144},//A
//		 {978, 900, 1065, 1151, 1236, 1249, 2222, 1362},//B
//		 {1000, 913, 1009, 1158, 1360, 1539, 1555, 1514},//C
//		 {931, 1000, 1138, 1251, 1450, 1550, 2222, 1653},//D
//		 {889, 1179, 1245, 1440, 1770, 1890, 1883, 1855},//E
//		 {959, 1210, 2222, 1665, 1668, 1817, 1921, 1866},//F
//		 {992, 1017, 1397, 1473, 1560, 1680, 1717, 1799},//G
//		 {927, 966, 1054, 1018, 942, 856, 997, 1046} //H
//		},//black queen
//		{{1426, 1196, 1231, 1181, 1192, 1326, 1221, 1310},//A
//		 {1241, 1263, 1460, 1555, 1456, 1495, 2222, 1490},//B
//		 {1339, 1110, 1225, 1447, 1410, 1660, 1740, 1660},//C
//		 {1403, 1141, 1257, 1367, 1522, 1740, 2222, 1753},//D
//		 {1167, 1277, 1420, 1550, 1872, 1925, 1952, 1949},//E
//		 {1407, 1258, 2222, 1737, 1764, 1921, 2066, 1933},//F
//		 {1048, 1104, 1428, 1538, 1657, 1773, 1842, 1920},//G
//		 {1014, 1125, 1289, 1440, 1344, 1107, 1450, 1173} //H
//		}//black king
//
//};

uint32_t board_defaults_hardcoded [8][8] = {
		{2487, 2509, 2478, 2507, 2475, 2491, 2498, 2511},
		{2525, 2488, 2468, 2465, 2453, 2460, 2222, 2444},
		{2537, 2403, 2370, 2389, 2331, 2396, 2418, 2362},
		{2312, 2292, 2289, 2246, 2252, 2259, 2222, 2254},
		{2286, 2377, 2452, 2382, 2424, 2425, 2423, 2401},
		{2390, 2411, 2222, 2413, 2386, 2372, 2404, 2350},
		{2388, 2428, 2374, 2385, 2366, 2334, 2421, 2390},
		{2459, 2518, 2561, 2494, 2500, 2458, 2458, 2512}
};

uint32_t board_defaults_calculated [8][8] = {
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0}
};

void custom_readCurrentBoard(char (*nextBoard)[8]){
//	char* newboard[8][8] = &board;
	uint32_t ADC_VAL = 0;
	for(int i = 0; i < 8; i++){
		setMuxVal(i, &masterMux);
		for (int j = 0; j < 8; j++){
			setMuxVal(j, &colMux);
			HAL_Delay(50);
			for (int m = 0; m < 20; ++m){
				HAL_ADC_Start(&hadc1);
				HAL_ADC_PollForConversion(&hadc1, 0xffffffff);
				ADC_VAL += HAL_ADC_GetValue(&hadc1);
	}
				ADC_VAL = ADC_VAL/20;
		uint8_t match = 0;
		int choice = -1;
		int choice_diff = 999999;
		for (int k = 0; k < 13; ++k) {
			 int diff = abs((int)ADC_VAL - (int)board_defaults_calculated[i][j] - (int)hallValues[k][i][j] + (int)board_defaults_hardcoded[i][j] );
			 if(k == WQ || k == BQ){
				 diff -= 63;
			 }
			 if(k == WP || k == BP){
				 diff += 6;
			 }
			 if(k == BB){
				 diff -= 25;
			 }


				if (diff < choice_diff) {

					choice = k;
					choice_diff = diff;

					}
				}
				nextBoard[abs(j-7)][i] = pieces[choice];
		}
	}
	if(board[6][6] == '-') nextBoard[6][6] = '-';
	else nextBoard[6][6] = board[6][6];
	if(board[5][5] == '-') nextBoard[5][5] = '-';
	else nextBoard[5][5] = board[5][5];
	if(board[1][3] == '-') nextBoard[1][3] = '-';
	else nextBoard[1][3] = board[1][3];
	if(board[1][1] == '-') nextBoard[1][1] = '-';
	else nextBoard[1][1] = board[1][1];
	HAL_Delay(10);
}
//enum white_black {WHITE, EMPTY, BLACK};
char white_or_black[3] = {'w', '-', 'l'};

void convert_to_blackwhite(char (*bwboard)[8], char (*clboard)[8]){
	for(int i = 0; i < 8; i++){
		for (int j = 0; j < 8; j++){
			if (clboard[i][j] == 45){
				bwboard[i][j]= '-';
			}
			else if (clboard[i][j] == 'P' || clboard[i][j] == 'N' ||clboard[i][j] == 'R' ||clboard[i][j] == 'B' ||clboard[i][j] == 'Q' ||clboard[i][j] == 'K'){
				bwboard[i][j] = 'w';
			}
			else {
				bwboard[i][j] = 'l';
			}
		}
	}
}

void blackwhite_readCurrentBoard(char (*nextBoard)[8]){
	uint32_t ADC_VAL = 0;
		for(int i = 0; i < 8; i++){
			setMuxVal(i, &masterMux);
			for (int j = 0; j < 8; j++){
				setMuxVal(j, &colMux);
				HAL_Delay(50);
				for (int m = 0; m < 20; ++m){
					HAL_ADC_Start(&hadc1);
					HAL_ADC_PollForConversion(&hadc1, 0xffffffff);
					ADC_VAL += HAL_ADC_GetValue(&hadc1);
				}
				ADC_VAL = ADC_VAL/20;
				uint8_t match = 0;
				int choice = -1;
				int choice_diff = 999999;
				 int diff = (int)ADC_VAL - (int)board_defaults_calculated[i][j];
				 if (abs(diff) < TOLERANCE){
					 nextBoard[abs(j-7)][i] = '-';
				 }
				 else if(diff > 0){
					 //white piece
					 nextBoard[abs(j-7)][i] = 'w';
				 }else if (diff < 0){
					 nextBoard[abs(j-7)][i] = 'l';

				 }
			}
		}
		if(board[6][6] == '-') nextBoard[6][6] = '-';
		else nextBoard[6][6] = islower(board[6][6]) ? 'l' : 'w';
		if(board[5][5] == '-') nextBoard[5][5] = '-';
		else nextBoard[5][5] = islower(board[5][5]) ? 'l' : 'w';
		if(board[1][3] == '-') nextBoard[1][3] = '-';
		else nextBoard[1][3] = islower(board[1][3]) ? 'l' : 'w';
		if(board[1][1] == '-') nextBoard[1][1] = '-';
		else nextBoard[1][1] = islower(board[1][1]) ? 'l' : 'w';
}
void print_board(uint32_t (*board)[8]){
	for (int i = 0; i < 8 ;i++){
		for (int j = 0; j < 8; j++){
			printf("%d ", board[i][j]);

		}
		printf("\n\r");

	}
}

void print_board_char(char (*board)[8]){
	for (int i = 0; i < 8 ;i++){
			for (int j = 0; j < 8; j++){
				printf("%c ", board[i][j]);

			}
			printf("\n\r");

		}
	printf("\n\r");
}

void calibrate_hall_sensors(uint32_t (*defaults)[8]){
//	char** defaults = malloc(8*sizeof(char*));
//		//TODO read board with hall sensors'
//		for (int i = 0; i < 8; i++){
//			defaults[i] = malloc(8*sizeof(char));
//		}
	uint32_t ADC_VAL = 0;
	for (int i = 0; i < 8; i++) {
			setMuxVal(i, &masterMux); // 0 -> master mux
			for (int j = 0; j < 8; j++) {
				setMuxVal(j, &colMux);
				HAL_Delay(50);
				for (int k = 0; k < 20; ++k){
							HAL_ADC_Start(&hadc1);
						HAL_ADC_PollForConversion(&hadc1, 0xffffffff);
						ADC_VAL += HAL_ADC_GetValue(&hadc1);

						}
						ADC_VAL = ADC_VAL/20;

//				uint8_t match = 0;
//				for (int k = 0; k < 12; ++k) {
//					if (abs((int)ADC_VAL - (int)hallValues[k][i][j]) < TOLERANCE) {
//						newBoard[i][j] = pieces[k];
//						match = 1;
//						break;
//					}
//				}
//				if (!match) {
//					newBoard[i][j] = '-';
//				}
				defaults[i][j] = ADC_VAL;
			}
		}
}

int getColor(char input){
	if(input == 'l') return BLACK;
	if(input == 'w') return WHITE;
	if(islower(input)){
		return BLACK;
	}
	else{
		return WHITE;
	}
}

void findMoveFromBoards(char (*newBoard)[8], char* move){
	char destination[3];
	char origin[3];
	for(int i=0; i<8; i++){
		for(int j=0; j<8; j++){
			if((board[i][j] == '-') && newBoard[i][j] != '-'){
				sprintf(destination, "%c%d", 'A'+j , abs(i-8));
			}
			if(board[i][j] != '-' && getColor(board[i][j]) != getColor(newBoard[i][j])){
				sprintf(destination, "%c%d", 'A'+j, abs(i-8));
			}
			if(newBoard[i][j] == '-' && board[i][j] != '-'){
			    sprintf(origin, "%c%d", 'A'+j, abs(i-8));
			}
		}
	}
	move[0]='\0';
	strcpy(move, origin);
	strcpy(&move[2], destination);
}



//update board to new board given full board
void updateBoard(char (*newBoard)[8]){
	for(int i=0; i<8; i++){
		strncpy(board[i], newBoard[i], 8);
	}
}


Mux* newMux(Pin* pin0, Pin* pin1, Pin* pin2) {
	Mux *mux = (Mux *) malloc(sizeof(Mux));
	mux->sel0 = pin0;
	mux->sel1 = pin1;
	mux->sel2 = pin2;
}

void setMuxVal(uint16_t val, Mux* mux) {
	writePin(mux->sel0, val & 1);
	writePin(mux->sel1, (val >> 1) & 1);
	writePin(mux->sel2, val >> 2);
}

Pin *new_pin(GPIO_TypeDef* _port, uint16_t _pin) {
    Pin *pin = (Pin *) malloc(sizeof(Pin));
    pin->port = _port;
    pin->pin = _pin;

    return pin;
}

int readPin(Pin* pin) {
	return HAL_GPIO_ReadPin(pin->port, pin->pin);
}

void writePin(Pin* pin, int val) {
	HAL_GPIO_WritePin(pin->port, pin->pin, val);
}

void boardToFEN(char (*board)[8], char* FEN){
	int emptyCount = 0;
	for (int i = 0; i < 8; i++){
		for (int j = 0;j < 8;j++){
			if(board[i][j] != '-'){
				if(emptyCount != 0){
					char c = emptyCount + '0';
					strncat(FEN,&c , 1);
					strncat(FEN,&board[i][j] , 1);
					emptyCount = 0;
				}
				else{
					strncat(FEN,&board[i][j] , 1);
				}
			}
			else{
				emptyCount++;
			}
		}
		char c = emptyCount + '0';
		if(emptyCount != 0)strncat(FEN,&c , 1);
		emptyCount = 0;
		char fSlash = '/';
		if(i!=7) strncat(FEN,&fSlash , 1);
	}

	char space = ' ';
	char dash[8] = " - - 0 1";
	strncat(FEN, &space, 1);
	strncat(FEN, &activeColor, 1);
	strncat(FEN, &dash, 8);
	return FEN;
}

int letterToCol(char letter){
	return letter - 'A';
}
int numberToRow(int num){
	return abs(num-8);
}
void checkMoveForPickup(char move[5]){
	char start[3];
	char goal[3];
	char curSquare[3];

	strncpy(start, move, 2);
	start[2] = '\0';
	strncpy(goal, move+2, 2);
	goal[2] = '\0';
	strncpy(curSquare, start, 2);
	curSquare[2] = '\0';

	int goalRow = numberToRow(goal[1]-'0');
	int goalCol = letterToCol(goal[0]);
	if(board[goalRow][goalCol] != '-'){
		strcpy(toPickUp[numToPickUp], goal);
		numToPickUp++;
	}
	int curRow = numberToRow(curSquare[1]-'0');
	int curCol = letterToCol(curSquare[0]);
	if(board[curRow][curCol] == 'n' || board[curRow][curCol] == 'N'){
		int rowDelta = curRow-goalRow;
		int colDelta = curCol-goalCol;
		if(abs(rowDelta)>abs(colDelta)){
			curRow += -rowDelta/abs(rowDelta);
			curSquare[1] += rowDelta/abs(rowDelta);
			if(board[curRow][curCol] != '-'){
				strcpy(toPickUp[numToPickUp], curSquare);
				numToPickUp++;
			}
			curRow += -rowDelta/abs(rowDelta);
			curSquare[1] += rowDelta/abs(rowDelta);
			if(board[curRow][curCol] != '-'){
				strcpy(toPickUp[numToPickUp], curSquare);
				numToPickUp++;
			}
		}
		else{
			curCol += -colDelta/abs(colDelta);
			curSquare[0] += -colDelta/abs(colDelta);
			if(board[curRow][curCol] != '-'){
				strcpy(toPickUp[numToPickUp], curSquare);
				numToPickUp++;
			}
			curCol += -colDelta/abs(colDelta);
			curSquare[0] += -colDelta/abs(colDelta);
			if(board[curRow][curCol] != '-'){
				strcpy(toPickUp[numToPickUp], curSquare);
				numToPickUp++;
			}
		}
	}
}

void moveOnBoard(char move[5]){
	char start[3];
	char goal[3];

	strncpy(start, move, 2);
	start[2] = '\0';
	strncpy(goal, move+2, 2);
	goal[2] = '\0';

	board[abs(atoi(&goal[1])-8)][goal[0]-'A'] = board[abs(atoi(&start[1])-8)][start[0]-'A'];
	board[abs(atoi(&start[1])-8)][start[0]-'A'] = '-';
}

void updatePieceAtSquare(char* square, char value){
	board[numberToRow(square[1])][letterToCol(square[0])] = value;
}
char pieceAtSquare(char* square){
	return board[numberToRow(square[1])][letterToCol(square[0])];
}
