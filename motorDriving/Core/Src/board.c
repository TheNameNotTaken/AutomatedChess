#include "board.h"
#include "main.h"

#define TOLERANCE 15

extern ADC_HandleTypeDef hadc1;

// add pin assignments
Pin masterSel0 = {GPIOC, GPIO_PIN_6};
Pin masterSel1 = {GPIOB, GPIO_PIN_15};
Pin masterSel2 = {GPIOB, GPIO_PIN_13};
Mux masterMux = {&masterSel0, &masterSel1, &masterSel2};

Pin colSel0 = {GPIOB, GPIO_PIN_12};
Pin colSel1 = {GPIOA, GPIO_PIN_4};
Pin colSel2 = {GPIOB, GPIO_PIN_4};
Mux colMux = {&colSel0, &colSel1, &colSel2};

/*
 * chess board has default value shown below
 * uppercase letters mean that a piece is white and undercase means black
 * legend is following:
 * r/R = rook
 * n/N = knight
 * b/B = bishop
 * k/K = king
 * q/Q = queen
 * p/P = pawn
 * - = empty space
 */
char board[8][8] = 	{{'r', 'n', 'b', 'k', 'q', 'b', 'n', 'r'},
					 {'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'-', '-', '-', '-', '-', '-', '-', '-'},
					 {'P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'},
					 {'R', 'N', 'B', 'K', 'Q', 'B', 'N', 'R'}};


//Next to move, 'w' for white 'b' for black
char activeColor = 'w';

char playerColor = 'w';

char pieces[24] = {'p', 'r', 'n', 'b', 'q', 'k', 'P', 'R', 'N', 'B', 'Q', 'K'};

uint32_t hallValues[12][8][8] = {
		//square for WP
		//the squares at B6, D6, F2 does not work
		{{2861, 2851, 2977, 2986, 2783, 3015, 2870, 2995},//A
		 {3095, 3071, 2822, 2922, 2807, 2727, 2222, 2696},//B
		 {2819, 2897, 2692, 2660, 2548, 2597, 2560, 2531},//C
		 {2742, 2631, 2624, 2519, 2453, 2427, 2222, 2369},//D
		 {2730, 2746, 2831, 2592, 2558, 2514, 2514, 2445},//E
		 {2641, 2800, 2222, 2628, 2549, 2468, 2471, 2417},//F
		 {2866, 2927, 2685, 2615, 2568, 2490, 2575, 2493},//G
		 {2843, 3121, 3047, 2946, 2949, 2915, 2920, 2991} //H
		},//pawn
		{{2965, 3088, 3125, 3087, 3085, 3138, 3120, 3060},//A
		 {3205, 3211, 2972, 3057, 2863, 2861, 2222, 2710},//B
		 {2972, 2932, 2713, 2750, 2702, 2700, 2734, 2667},//C
		 {2903, 2835, 2742, 2631, 2504, 2541, 2222, 2439},//D
		 {2840, 2826, 2901, 2739, 2660, 2626, 2596, 2614},//E
		 {2924, 2863, 2222, 2774, 2655, 2596, 2562, 2532},//F
		 {3011, 3064, 2805, 2731, 2683, 2604, 2677, 2600},//G
		 {3169, 3073, 3113, 3135, 3146, 3241, 2823, 3027} //H
		},//horse
		{{3011, 2886, 2904, 2968, 2857, 2965, 2500, 2935},//A
		 {2976, 2998, 2848, 2847, 2785, 2760, 2222, 2710},//B
		 {2787, 2705, 2767, 2729, 2600, 2649, 2559, 2497},//C
		 {2758, 2616, 2591, 2525, 2442, 2447, 2222, 2396},//D
		 {2626, 2702, 2803, 2571, 2589, 2555, 2567, 2542},//E
		 {2823, 2794, 2222, 2666, 2558, 2499, 2537, 2469},//F
		 {2777, 2872, 2703, 2645, 2575, 2524, 2598, 2531},//G
		 {2895, 3031, 3072, 2904, 2929, 2933, 2947, 2953} //H
		},//rook
		{{3516, 3471, 3405, 3436, 3394, 3430, 3385, 3231},//A
		 {3421, 3462, 3273, 3202, 3065, 3118, 2222, 3068},//B
		 {3237, 3323, 3237, 3100, 2950, 2800, 2887, 2826},//C
		 {3119, 3071, 2946, 2804, 2627, 2677, 2222, 2592},//D
		 {3098, 3146, 3174, 2934, 2811, 2788, 2748, 2716},//E
		 {3085, 3090, 2222, 2943, 2810, 2690, 2708, 2630},//F
		 {3289, 3319, 2914, 2954, 2843, 2708, 2792, 2763},//G
		 {3298, 3482, 3536, 3406, 3507, 3467, 3423, 3371} //H
		},//bishop
		{{4047, 4048, 4000, 4037, 3802, 3920, 4047, 3850},//A
		 {4051, 4066, 4004, 3955, 3678, 3738, 2222, 3629},//B
		 {3890, 3888, 3870, 3619, 3411, 3468, 3264, 3142},//C
		 {3699, 3693, 3442, 3259, 3109, 2975, 2222, 2877},//D
		 {3661, 3767, 3771, 3268, 3153, 2978, 2986, 3018},//E
		 {3859, 3575, 2222, 3400, 3172, 3021, 3989, 2886},//F
		 {3852, 3918, 3620, 3449, 3188, 3118, 3200, 3137},//G
		 {3923, 4089, 4068, 4062, 3593, 4084, 4080, 4047} //H
		},//queen
		{{3981, 3840, 3740, 3738, 3788, 3814, 3815, 3553},//A
		 {3787, 3959, 3486, 3575, 3318, 3439, 2222, 3213},//B
		 {3641, 3574, 3603, 3462, 3211, 3156, 3116, 3080},//C
		 {3363, 3171, 3147, 3099, 2940, 2880, 2222, 2777},//D
		 {3205, 3455, 3397, 3188, 2960, 2918, 2822, 2871},//E
		 {3653, 3332, 2222, 3143, 2959, 2872, 2849, 2763},//F
		 {3679, 3532, 3366, 3208, 3048, 2969, 3013, 2964},//G
		 {3845, 3722, 3900, 3643, 3870, 3808, 3842, 3718} //H
		},//king


		{{1953, 2195, 1922, 2303, 1955, 2100, 2047, 2156},//A
		 {2140, 1931, 2083, 2090, 2110, 2309, 2222, 2160},//B
		 {2014, 1993, 1902, 2070, 2093, 2251, 2248, 2212},//C
		 {1976, 1867, 1952, 2025, 2126, 2133, 2222, 2174},//D
		 {1774, 2096, 2121, 2151, 2282, 2290, 2330, 2350},//E
		 {1896, 2002, 2222, 2190, 2237, 2260, 2320, 2269},//F
		 {1913, 2000, 2175, 2157, 2182, 2196, 2270, 2260},//G
		 {1985, 1902, 2027, 2155, 1998, 1814, 2133, 2140} //H
		},//black pawn
		{{1985, 1881, 1774, 1836, 2193, 1766, 2108, 2157},//A
		 {1839, 1702, 1904, 1885, 1994, 1988, 2222, 1983},//B
		 {1699, 1757, 1731, 1858, 1902, 2118, 2102, 2046},//C
		 {1666, 1751, 1798, 1818, 1935, 1972, 2222, 2106},//D
		 {1638, 1831, 1937, 1984, 2151, 2169, 2222, 2188},//E
		 {1746, 1855, 2222, 2042, 2113, 2139, 2243, 2168},//F
		 {1738, 1771, 1900, 2001, 2052, 2049, 2146, 2135},//G
		 {1734, 1834, 1978, 1960, 1912, 1649, 1704, 1849} //H
		},//black horse
		{{2046, 2143, 1944, 2055, 2193, 1766, 2108, 2157},//A
		 {2015, 1894, 2120, 2074, 2205, 1649, 2222, 2143},//B
		 {1897, 1944, 1869, 2028, 2039, 2154, 2200, 2121},//C
		 {1968, 1845, 1921, 1958, 1992, 2019, 2222, 2122},//D
		 {1560, 2053, 2098, 2130, 2243, 2250, 2280, 2072},//E
		 {1892, 1985, 2222, 2183, 2183, 2227, 2257, 2218},//F
		 {2008, 1944, 2066, 2093, 2125, 2127, 2230, 2206},//G
		 {1908, 1930, 2002, 1994, 2066, 1898, 1921, 1997} //H
		},//black rook
		{{1726, 1737, 1625, 1724, 1559, 1595, 1458, 1769},//A
		 {1599, 1428, 1747, 1620, 1675, 2125, 2222, 1761},//B
		 {1438, 1450, 1448, 1678, 1797, 1857, 1874, 1878},//C
		 {1500, 1385, 1573, 1689, 1745, 1811, 2222, 1927},//D
		 {1313, 1558, 1654, 1786, 2030, 2109, 2079, 2072},//E
		 {1514, 1701, 2222, 1897, 1993, 2006, 2125, 2054},//F
		 {1463, 1448, 1649, 1783, 1889, 1928, 2058, 2055},//G
		 {1545, 1546, 1427, 1518, 1405, 1307, 1578, 1510} //H
		},//black bishop
		{{972, 981, 970, 1128, 995, 1052, 1083, 1144},//A
		 {978, 900, 1065, 1151, 1236, 1249, 2222, 1362},//B
		 {1000, 913, 1009, 1158, 1360, 1539, 1555, 1514},//C
		 {931, 1000, 1138, 1251, 1450, 1550, 2222, 1653},//D
		 {889, 1179, 1245, 1440, 1770, 1890, 1883, 1855},//E
		 {959, 1210, 2222, 1665, 1668, 1817, 1921, 1866},//F
		 {992, 1017, 1397, 1473, 1560, 1680, 1717, 1799},//G
		 {927, 966, 1054, 1018, 942, 856, 997, 1046} //H
		},//black queen
		{{1426, 1196, 1231, 1181, 1192, 1326, 1221, 1310},//A
		 {1241, 1263, 1460, 1555, 1456, 1495, 2222, 1490},//B
		 {1339, 1110, 1225, 1447, 1410, 1660, 1740, 1660},//C
		 {1403, 1141, 1257, 1367, 1522, 1740, 2222, 1753},//D
		 {1167, 1277, 1420, 1550, 1872, 1925, 1952, 1949},//E
		 {1407, 1258, 2222, 1737, 1764, 1921, 2066, 1933},//F
		 {1048, 1104, 1428, 1538, 1657, 1773, 1842, 1920},//G
		 {1014, 1125, 1289, 1440, 1344, 1107, 1450, 1173} //H
		}//black queen

};


//void custom_readCurrentBoard(){
////	char* newboard[8][8] = &board;
//	uint32_t ADC_VAL = 0;
//	for(int i = 0; i < 8; i++){
//		setMuxVal(i, &masterMux);
//		for (int j = 0; j < 8; j++){
//			setMuxVal(j, &colMux);
//			for (int j = 0; j < 20; ++j){
//				HAL_ADC_Start(&hadc1);
//				HAL_ADC_PollForConversion(&hadc1, 0xffffffff);
//				ADC_VAL += HAL_ADC_GetValue(&hadc1);
//	}
//				ADC_VAL = ADC_VAL/20;
//		uint8_t match = 0;
//		for (int k = 0; k < 12; ++k) {
//				if (abs((int)ADC_VAL - (int)hallValues[k][i][j]) < TOLERANCE) {
//					newboard[i][j] = pieces[k];
//					match = 1;
//					break;
//					}
//				}
//				if (!match) {
//					newboard[i][j] = '-';
//				}
//		}
//	}
//	HAL_Delay(10);
//}

//Must free new board afterwards
char** readCurrentBoard(){

	char** newBoard = malloc(8*sizeof(char*));
	//TODO read board with hall sensors'
	for (int i = 0; i < 8; i++){
		newBoard[i] = malloc(8*sizeof(char));
	}
	uint32_t ADC_VAL = 0;
	// don't worry about enable pins
	for (int i = 0; i < 8; i++) {
		setMuxVal(i, &masterMux); // 0 -> master mux
		for (int j = 0; j < 8; j++) {
			setMuxVal(j, &colMux);

			for (int j = 0; j < 20; ++j){
						HAL_ADC_Start(&hadc1);
					HAL_ADC_PollForConversion(&hadc1, 0xffffffff);
					ADC_VAL += HAL_ADC_GetValue(&hadc1);

					}
					ADC_VAL = ADC_VAL/20;

			uint8_t match = 0;
			for (int k = 0; k < 12; ++k) {
				if (abs((int)ADC_VAL - (int)hallValues[k][i][j]) < TOLERANCE) {
					newBoard[i][j] = pieces[k];
					match = 1;
					break;
				}
			}
			if (!match) {
				newBoard[i][j] = '-';
			}
		}
	}
	//return rows;
	HAL_Delay(10);
	return newBoard;
}



//update board to new board given full board
void updateBoard(char** newBoard){
	for(int i=0; i<8; i++){
		strncpy(board[i], newBoard[i], 8);
	}
}


Mux* newMux(Pin* pin0, Pin* pin1, Pin* pin2) {
	Mux *mux = (Mux *) malloc(sizeof(Mux));
	mux->sel0 = pin0;
	mux->sel1 = pin1;
	mux->sel2 = pin2;
}

void setMuxVal(uint16_t val, Mux* mux) {
	writePin(mux->sel0, val << 2);
	writePin(mux->sel1, (val >> 1) & 1);
	writePin(mux->sel2, val >> 2);
}

Pin *new_pin(GPIO_TypeDef* _port, uint16_t _pin) {
    Pin *pin = (Pin *) malloc(sizeof(Pin));
    pin->port = _port;
    pin->pin = _pin;

    return pin;
}

int readPin(Pin* pin) {
	return HAL_GPIO_ReadPin(pin->port, pin->pin);
}

void writePin(Pin* pin, int val) {
	HAL_GPIO_WritePin(pin->port, pin->pin, val);
}
